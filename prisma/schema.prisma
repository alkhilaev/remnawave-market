// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  CANCELED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  CANCELED
  FAILED
}

enum PaymentType {
  DEPOSIT
  SUBSCRIPTION_PURCHASE
  SUBSCRIPTION_RENEWAL
}

enum PaymentProvider {
  YOOKASSA
  BALANCE
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(USER)
  balance   Decimal  @default(0) @db.Decimal(10, 2)

  isEmailVerified Boolean @default(false)
  emailVerificationToken String?

  refreshToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
  payments      Payment[]

  @@map("users")
}

model VPNPlan {
  id          String   @id @default(uuid())
  name        String
  description String?

  // Лимиты по умолчанию
  defaultTrafficLimitGB        Int // 0 = безлимит
  defaultBypassTrafficLimitGB  Int // Лимит обхода моб. заглушек
  defaultDeviceLimit           Int

  // Опции функционала
  bypassTrafficEnabled Boolean  @default(true) // Включен ли bypass трафик для этого тарифа

  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи с периодами и дополнениями
  periods         PlanPeriod[]
  extraTraffic    PlanExtraTraffic[]
  extraBypassTraffic PlanExtraBypassTraffic[]
  extraDevices    PlanExtraDevice[]
  subscriptions   Subscription[]

  @@map("vpn_plans")
}

// Периоды подписки для тарифа (1 месяц, 3 месяца и т.д.)
model PlanPeriod {
  id       String  @id @default(uuid())
  planId   String
  plan     VPNPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  durationDays Int     // Длительность в днях (30, 90, 180, 365 и т.д.)
  price        Decimal @db.Decimal(10, 2)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, durationDays])
  @@map("plan_periods")
}

// Дополнительный трафик (2000 GB, 4000 GB и т.д.)
model PlanExtraTraffic {
  id       String  @id @default(uuid())
  planId   String
  plan     VPNPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  trafficGB Int     // Количество GB
  price     Decimal @db.Decimal(10, 2)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, trafficGB])
  @@map("plan_extra_traffic")
}

// Дополнительный трафик обхода заглушек
model PlanExtraBypassTraffic {
  id       String  @id @default(uuid())
  planId   String
  plan     VPNPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  bypassTrafficGB Int     // Количество GB для обхода заглушек
  price           Decimal @db.Decimal(10, 2)
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, bypassTrafficGB])
  @@map("plan_extra_bypass_traffic")
}

// Дополнительные устройства (4 устройства, 6 устройств и т.д.)
model PlanExtraDevice {
  id       String  @id @default(uuid())
  planId   String
  plan     VPNPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  deviceCount Int     // Количество устройств
  price       Decimal @db.Decimal(10, 2)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, deviceCount])
  @@map("plan_extra_devices")
}

model Subscription {
  id     String @id @default(uuid())
  userId String
  planId String

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan VPNPlan @relation(fields: [planId], references: [id])

  // Remnawave integration
  remnawaveKeyId   String? // VPN key ID in Remnawave
  remnawaveUsername String? // Username in Remnawave

  status SubscriptionStatus @default(ACTIVE)

  // Лимиты (включая купленные дополнения)
  trafficLimitGB       Int // Общий лимит трафика
  bypassTrafficLimitGB Int // Лимит обхода заглушек
  deviceLimit          Int // Количество устройств

  // Период подписки
  durationDays Int      // Длительность в днях
  startDate    DateTime
  expiryDate   DateTime

  // Auto-renewal
  autoRenewal Boolean @default(false)
  autoRenewalPaymentMethodId String? // YooKassa payment method ID for recurring payments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([expiryDate])
  @@map("subscriptions")
}

model Payment {
  id     String @id @default(uuid())
  userId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   PaymentType
  amount Decimal @db.Decimal(10, 2)
  status PaymentStatus @default(PENDING)

  provider          PaymentProvider
  providerPaymentId String? // External payment ID (e.g., YooKassa payment ID)

  // Metadata for storing additional info (subscription ID, etc.)
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([providerPaymentId])
  @@map("payments")
}
